openapi: "3.0"
info:
  version: 1.0.0
  title: CLI configuration
host: "app.zegami.com"
type: object
properties:
    # Data set config
  dataset_type:
    type: string # enums are further down, dont need to repeat here
  file_config:
    type: object
    properties:
      recursive:
        type: boolean
      mime_type:
        type: string
        pattern: ^[-\w.]+/[-\w.]+$
      path:
        type: string
        pattern: \.(tab|tsv|csv|xlsx)$
      directory:
        type: string
      paths:
        type: array
        items:
          type: string
  sql_config:
    type: object
    properties:
      connection:
        type: string
      query:
        type: string
    required:
    - connection
    - query
  # Image set config
  imageset_type:
    type: string # enums are further down, dont need to repeat here
  collection_id:
    type: string
    pattern: ^[0-9a-fA-F]{24}$
  dataset_id:
    type: string
    pattern: ^[0-9a-fA-F]{24}$
  dataset_column:
    type: string
  # publish collection config
  update_type:
    type: string
    enum:
    - publish
    - imageset_update
    - dataset_update
    - collection_create
  publish_config:
    type: object
    properties:
      publish:
        type: boolean
      destination_project:
        type: string
    required:
    - publish
    - destination_project
definitions:
  collection:
    properties:
      name:
        type: string
        description: name for the collection
      description:
        oneOf:
        - type: string
          description: descriptive text for the collection
        - enum:
          - null
      enable_clustering:
        type: boolean
        description: whether to enable clustering for the collection
      use_wsi:
        type: boolean
        description: whether the images are whole slide images
    required:
    - name
  file_dataset:
    properties:
      dataset_type:
        enum:
        - file
      file_config:
        oneOf:
        - required:
          - path
        - required:
          - directory
    required:
    - file_config
  sql_dataset:
    properties:
      dataset_type:
        enum:
        - sql
    required:
    - sql_config
  file_imageset_properties:
    properties:
      imageset_type:
        enum:
        - file
      file_config:
        required:
        - paths
  url_imageset_properties:
    properties:
      imageset_type:
        enum:
        - url
      url_template:
        type: string
      image_fetch_headers:
        type: object
  azure_storage_container_properties:
    properties:
      imageset_type:
        enum:
        - azure_storage_container
      container_name:
        type: string
anyOf:
# dataset only
- oneOf:
  - allOf:
    - $ref: '#/definitions/file_dataset'
    - required:
      - dataset_type
      - file_config
  - allOf:
    - $ref: '#/definitions/sql_dataset'
    - required:
      - dataset_type
      - sql_config
# imageset only
- oneOf:
  - allOf:
    - $ref: '#/definitions/file_imageset_properties'
    - required:
      - file_config
      - collection_id
      - dataset_id
      - imageset_type
  - allOf:
    - $ref: '#/definitions/url_imageset_properties'
    - required:
      - collection_id
      - dataset_id
      - imageset_type
  - allOf:
    - $ref: '#/definitions/azure_storage_container_properties'
    - required:
      - collection_id
      - dataset_id
      - imageset_type
      - container_name
# collection create should have a name and contain all configuration but no ids
- allOf:
  - $ref: '#/definitions/collection'
  - oneOf:
    - allOf:
      - $ref: '#/definitions/file_dataset'
      - required:
        - dataset_type
        - file_config
    - allOf:
      - $ref: '#/definitions/sql_dataset'
      - required:
        - dataset_type
        - sql_config
  - oneOf:
    - allOf:
      - $ref: '#/definitions/file_imageset_properties'
      - required:
        - file_config
        - imageset_type
    - allOf:
      - $ref: '#/definitions/url_imageset_properties'
      - required:
        - imageset_type
    - allOf:
      - $ref: '#/definitions/azure_storage_container_properties'
      - required:
        - imageset_type
        - container_name
# multiple image sources collection
- allOf:
  - $ref: '#/definitions/collection'
  - enable_image_info:
    type: boolean
  - collection_version:
      enum:
      - 2
  - oneOf:
    - allOf:
      - $ref: '#/definitions/file_dataset'
    - allOf:
      - $ref: '#/definitions/sql_dataset'
  - image_sources:
      type: array
      items:
        type: object
        properties:
          source_name:
            type: string
          oneOf:
          - allOf:
            - properties:
              imageset_type:
                enum:
                - file
              $ref: '#/properties/paths'
          - allOf:
            - $ref: '#/definitions/url_imageset_properties'
            - required:
              - imageset_type
          - allOf:
            - $ref: '#/definitions/azure_storage_container_properties'
            - required:
              - imageset_type
              - container_name
          required:
          - source_name
  - required:
    - collection_version
    - image_sources
# images only collection
- allOf:
  - $ref: '#/definitions/collection'
  - oneOf:
    - allOf:
      - $ref: '#/definitions/file_imageset_properties'
      - required:
        - file_config
        - imageset_type
    - allOf:
      - $ref: '#/definitions/url_imageset_properties'
      - required:
        - imageset_type
    - allOf:
      - $ref: '#/definitions/azure_storage_container_properties'
      - required:
        - imageset_type
        - container_name
# collection publish stuff
- oneOf:
  - properties:
      update_type:
        enum:
        - publish
    required:
    - publish_config
    - update_type
